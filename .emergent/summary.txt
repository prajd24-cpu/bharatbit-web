<analysis>**original_problem_statement**:
The user wants to build a premium Over-the-Counter (OTC) crypto trading desk mobile and web application named BharatBit OTC Desk. The application is targeted at high-net-worth Indian and international clients and should have a premium and secure user experience.

**PRODUCT REQUIREMENTS:**
- **Branding:** Premium, light theme with a white background, orange buttons (), and dark navy blue text. A specific B logo has been integrated.
- **Core Features:**
    1.  **User Registration:** Mobile + Country Code, Email + OTP (Email/SMS). Support for Individual and Corporate/Entity account types.
    2.  **Full KYC Module:** Admin approval workflow. Different document requirements for Individual (PAN, Aadhaar, Selfie) vs. Corporate accounts. Passport is mandatory for non-Indian clients. Must support both file uploads and live camera captures.
    3.  **Secure Login:** 2FA (Email and SMS OTP), Biometrics.
    4.  **Dashboard:** Portfolio summary, active orders, live crypto price charts, prominent KYC status banner.
    5.  **Place OTC Order:**
        - **Buy Flow:** Standard buy order.
        - **Sell Flow:** User must see their available asset balances, select an asset to sell, and see their registered bank account where funds will be sent.
        - **Disclaimer:** All prices shown are indicative/for reference only, and final execution price will be confirmed manually.
    6.  **Wallet Management:** Users can add external crypto wallet addresses with proof of ownership for admin verification.
    7.  **Admin Panel:** User management, KYC approval, Order management, Wallet address verification, enhanced analytics dashboards.
    8.  **Forgot Password Flow**.
- **Integrations:**
    - **Email:** Resend (LIVE).
    - **SMS:** MSG91 (Integrated, but delivery is BLOCKED pending user's DLT registration).
    - **Live Prices:** CoinGecko (Integrated).
    - **KYC:** Signzy (Planned, stubbed).
- **Notifications:** Push notifications for KYC/order status changes (Partially implemented).

**User's preferred language**: English

**what currently exists?**
A full-stack application (Expo/React Native frontend, FastAPI backend) supporting both mobile and web.
- **Backend:** The monolithic  has been successfully refactored into a modular architecture using FastAPI  for auth, admin, orders, wallets, etc. It includes APIs for user authentication (supporting both Individual/Corporate types in the model), a multi-step KYC workflow, OTC order management, wallet services, and live crypto price fetching from CoinGecko.
- **Frontend:** A complete UI with a tab-based layout. It features authentication screens, a multi-step KYC form with camera/upload capabilities, a dashboard, and an order creation screen. The sell-side order flow has been refactored to show user balances and bank details.
- **Integrations:**
    - **Resend** is LIVE for emails.
    - **MSG91** is integrated for SMS, but SMS delivery fails because the user needs to complete DLT registration in India. The agent has informed the user what is needed (Template ID, Sender ID).
    - **CoinGecko** is integrated for live crypto prices.

**Last working item**:
    - Last item agent was working: Adding Individual vs. Corporate/Entity account types. The agent updated the backend user model and registration endpoint to include an  field. It was in the process of updating the frontend registration screen to include this choice and making the KYC form conditional based on the selection.
    - Status: IN PROGRESS
    - Agent Testing Done: N
    - Which testing method agent to use? both
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - Issue 1: Preview Environment Instability (P0)
  - Issue 2: MSG91 SMS Delivery Failure (P0)
  - Issue 3: Complete Account Type Implementation (Individual vs. Corporate) (P0)

  Issues Detail:
  - Issue 1: 
     - Description: The application preview provided by  is extremely unstable and frequently times out or returns  /  errors. This is a recurring environmental issue that has wasted significant time on restarts and cache clearing. It severely hinders frontend development and user testing.
     - Attempted fixes: Numerous 
  Usage: expo [command] [options]

  Options:
  
    -V, --version                     output the version number
    --non-interactive                 Fail, if an interactive prompt would be required to continue.
    -h, --help                        output usage information
  
  Commands:

    init [name]                       Create a new Expo project
    start [path]                      Start a local dev server for the app
    start:web [path]                  Start a Webpack dev server for the web app
    export [path]                     Export the static files of the app for hosting it on a web server
    install [packages...]             Install a module or other package to a project
    run:android [path]                Run the Android app binary locally
    run:ios [path]                    Run the iOS app binary locally
    send [path]                       Share the project's URL to an email address

    login                             Login to an Expo account
    logout                            Logout of an Expo account
    register                          Sign up for a new Expo account
    whoami                            Return the currently authenticated account

    client:install:ios                Install Expo Go for iOS on the simulator
    client:install:android            Install Expo Go for Android on a connected device or emulator

    config [path]                     Show the project config
    doctor [path]                     Diagnose issues with the project
    upgrade [sdk-version]             Upgrade the project packages and config for the given SDK version

    customize:web [path]              Eject the default web files for customization
    prebuild [path]                   Create native iOS and Android project files before building natively.
                                      Learn more: https://docs.expo.dev/workflow/customizing/

    build:web [path]                  Build the web app for production

    credentials:manager [path]        Superseded by eas credentials in eas-cli

    url [path]                        Log a URL for opening the project in Expo Go
    url:ipa [path]                    Log the download URL for the standalone iOS binary
    url:apk [path]                    Log the download URL for the standalone Android binary

    webhooks [path]                   List all webhooks for a project
    webhooks:add [path]               Add a webhook to a project
    webhooks:remove [path]            Delete a webhook
    webhooks:update [path]            Update an existing webhook

    build:ios [path]                  Superseded by eas build in eas-cli
    build:android [path]              Superseded by eas build in eas-cli
    build:status [path]               Superseded by eas build:list in eas-cli
    eject [path]                      Superseded by expo prebuild
    fetch:ios:certs [path]            Superseded by eas credentials in eas-cli
    fetch:android:keystore [path]     Superseded by eas credentials in eas-cli
    fetch:android:hashes [path]       Superseded by eas credentials in eas-cli
    fetch:android:upload-cert [path]  Superseded by eas credentials in eas-cli
    publish [path]                    Superseded by eas update in eas-cli
    publish:set [path]                Superseded by eas update:republish in eas-cli
    publish:rollback [path]           Superseded by eas update:republish in eas-cli
    publish:history [path]            Superseded by eas update:list in eas-cli
    publish:details [path]            Superseded by eas update:view in eas-cli
    push:android:upload [path]        Superseded by eas credentials in eas-cli
    push:android:show [path]          Superseded by eas credentials in eas-cli
    push:android:clear [path]         Superseded by eas credentials in eas-cli
    upload:android [path]             Superseded by eas submit in eas-cli
    upload:ios [path]                 Superseded by eas submit in eas-cli
    client:ios [path]                 Superseded by Expo Dev Clients

[14:32:37]   Run a command with --help for more info ðŸ’¡
[14:32:37]     $ expo start --help
[14:32:37] service restarts, clearing Metro cache (), and verifying local service health. The issue is with the tunnel infrastructure itself.
     - Next debug checklist: 
        1. Acknowledge this is an environmental issue.
        2. When it fails, perform a clean restart: frontend: ERROR (no such process)
frontend: ERROR (no such process).
        3. Wait up to 2 minutes for the tunnel to stabilize before testing.
        4. If it persists, focus on backend work that can be tested with  and inform the user about the preview outage.
     - Why fix this issue and what will be achieved with the fix? A stable preview is critical for user feedback and frontend debugging.
     - Status: BLOCKED
     - Is recurring issue? Y
     - Should Test frontend/backend/both after fix? Frontend
     - Blocked on other issue: None
  - Issue 2: 
     - Description: The MSG91 integration is complete in the code, but OTP SMS messages are not being delivered to the user's phone. The agent investigated and found that this is due to mandatory DLT (Distributed Ledger Technology) registration required for sending programmatic SMS in India.
     - Attempted fixes: Agent confirmed the API call is correct and receives a  from MSG91, but the delivery fails downstream. The agent researched the DLT requirement and informed the user.
     - Next debug checklist: 
        1. Wait for the user to provide the **DLT Template ID** and **Approved Sender ID**.
        2. Update  to include the  in the MSG91 API payload.
        3. Retest the registration flow to confirm SMS delivery.
     - Why fix this issue and what will be achieved with the fix? This will complete the 2FA security requirement and a core feature request.
     - Status: BLOCKED
     - Is recurring issue? N
     - Should Test frontend/backend/both after fix? Both
     - Blocked on other issue: User action required (DLT Registration).
  - Issue 3: 
     - Description: The user requested two account types: Individual and Corporate/Entity, with different KYC requirements for each. The agent has started implementation.
     - Attempted fixes: The  field was added to the backend User model and registration endpoint.
     - Next debug checklist:
        1. Modify  to add a selector (e.g., Radio buttons) for Individual or Corporate.
        2. Modify  to conditionally render different form fields based on the user's . (e.g., show PAN/Aadhaar for Individual, show company registration documents for Corporate).
        3. Update the backend KYC submission endpoint in  to handle the different data structures for each account type.
     - Why fix this issue and what will be achieved with the fix? This fulfills a key business requirement to onboard different types of clients.
     - Status: IN PROGRESS
     - Is recurring issue? N
     - Should Test frontend/backend/both after fix? Both
     - Blocked on other issue: None

**In progress Task List**:
  - Task 1:  Complete Account Type Implementation
     - Where to resume: Modify the frontend at  and  to reflect the new account types.
     - What will be achieved with this? Users will be able to sign up as either an Individual or a Corporate entity, with a corresponding tailored KYC process.
     - Status: IN PROGRESS
     - Should Test frontend/backend/both after fix? Both
     - Blocked on something: No

**Upcoming and Future Tasks**
    Upcoming Tasks:
    - **P1: Implement Frontend for Live Crypto Charts**: The backend API () and a component () exist. The component caused build issues and was removed from the dashboard. It needs to be debugged and re-integrated into .
    - **P1: Implement Push Notifications**: The backend service () is partially implemented. It needs to be triggered from relevant backend events (e.g., in  on KYC approval) and handled on the frontend.
    Future Tasks:
    - **P1: Enhanced Admin Analytics Frontend**: The backend API () is ready. The frontend needs a new view or component to display this data with charts.
    - **P2: Full App Store Deployment**: Guide the user through building and submitting the mobile app via Expo Application Services (EAS).
    - **P2: WhatsApp Notifications**: Integrate a provider like Twilio for WhatsApp messages.

**Completed work in this session**
- **Backend Refactoring**: Successfully migrated the entire backend from a single  file to a modular structure using FastAPI routers in the  directory.
- **Deployment Issue Fixes**: Resolved multiple  errors from deployment logs by adding alias routes (e.g., ) to maintain backward compatibility with frontend calls.
- **Sell-Side Order Flow Overhaul**: Rewrote the Create Order screen () to correctly handle Sell orders by displaying the user's asset balance and their registered bank account details. Added disclaimers that prices are indicative.
- **KYC Form Enhancements**: Upgraded the KYC form () to support both live camera capture and file uploads for documents. Added conditional logic for requiring a Passport for non-Indian clients.
- **Mobile Glitch Fixes**:
    - Removed the debug OTP from being displayed on the screen during login.
    - Fixed the mobile navigation bar from overlapping the app's tab bar by implementing .
    - Corrected the logout flow to properly redirect the user to the login screen.
- **Payment Details Update**: Updated the hardcoded company bank details and removed the UPI ID as requested by the user.

**Earlier issues found/mentioned but not fixed**
   - **Frontend Linting Errors**: The agent noted multiple TypeScript parsing errors during linting but ignored them as they didn't seem to be breaking the build at the time. These could cause future issues and should be addressed.

**Known issue recurrence from previous fork**
  - **Issue recurrence in previous fork**: The instability of the  preview environment was noted in the previous handoff summary.
  - **Recurrence count**: High. This has been a persistent blocker throughout the session.
  - **Status**: BLOCKED

**Code Architecture**


**Key Technical Concepts**
- **Frontend:** Expo (React Native, Web), TypeScript, .
- **Backend:** FastAPI, Python, Pydantic, JWT, Motor (async MongoDB), Modular Router architecture.
- **Database:** MongoDB.
- **Integrations:** Resend (Email), MSG91 (SMS), CoinGecko (Live Prices).

**key DB schema**
  - **users**:  (added )
  - **kyc_details**: 
  - **corporate_kyc_details**: 
  - **orders**: 
  - **wallet_addresses**: 

**changes in tech stack**
  -  added to backend for fetching crypto prices.

**All files of reference**
- : Refactored to use routers.
- : Entire new directory with modular endpoints.
- : Heavily modified to add camera/upload, passport logic.
- : Rewritten to support the new Sell flow.
- : Modified to fix logout and display more user details.
- : Modified to fix navigation bar overlap.
- : Updated with new bank details.

**Areas that need refactoring**:
- The  component needs to be debugged and fixed, as it was causing the Metro bundler to fail.
- The frontend has lingering TypeScript linting errors that should be cleaned up.

**key api endpoints**
- ,  (updated for  and flexible )
- ,  (New)
-  (New)
-  (Alias for  to fix deployment errors)
- ,  (New, hardcoded details)

**Critical Info for New Agent**
- **PRIORITY 1: Fix the preview environment or work around it.** The  tunnel is extremely unreliable. Expect to restart the frontend service frequently. If the preview is down, prioritize backend work that can be tested via .
- **PRIORITY 2: Complete the Individual vs. Corporate account feature.** This is the last active request from the user and is half-finished.
- **PRIORITY 3: The MSG91 SMS integration is BLOCKED.** Do not attempt to debug SMS delivery further until the user provides the **DLT Template ID** and **Sender ID**. The code is ready for these values.
- The deployment logs provided by the user showing  errors were from an older build. The agent has already added the necessary alias routes to fix this. The next deployment should resolve those errors.

**documents and test reports created in this job**
  - /app/memory/PRD.md (Updated)
  - /app/test_reports/iteration_1.json
  - /app/test_reports/iteration_2.json

**Last 10 User Messages and any pending HUMAN messages** 
- **10. **: User initiated a deployment. (Status: Followed by bug reports).
- **9. **: User provided deployment logs showing 404 errors. (Status: Completed, agent added alias routes).
- **8. **: User reported 3 bugs on the deployed mobile app: OTP shown on screen, navigation bar overlap, and incorrect KYC flow. (Status: Completed, agent fixed all 3).
- **7. **: User provided correct bank account details. (Status: Completed, agent updated them).
- **6. **: User requested UPI removal and a major fix to the Sell order flow. (Status: Completed, agent implemented both).
- **5. **: User requested to add a disclaimer that prices are indicative. (Status: Completed, agent added text).
- **4. **: User provided the same deployment logs again. (Status: Completed, agent confirmed fixes are in place for next deployment).
- **3. **: User reported the logout button doesn't redirect. (Status: Completed, agent fixed it).
- **2. **: User requested camera functionality in the KYC form. (Status: Completed, agent implemented it).
- **1.  and **: **LATEST**: User requested mandatory passport for international clients and the Corporate account type. (Status: IN PROGRESS).

**Project Health Check:**
- **Broken:**
    - The frontend preview environment ( tunnel).
    - SMS OTP delivery (Blocked on user's DLT registration).
- **Mocked:**
    - Signzy KYC Integration ( is a stub).
    - Push Notifications ( is partially implemented but not triggered).

**3rd Party Integrations**
- **Resend (Email)** â€” LIVE, requires User API Key.
- **MSG91 (SMS)** â€” INTEGRATED, requires User API Key. **DELIVERY BLOCKED** pending user DLT registration.
- **CoinGecko (Crypto Prices)** â€” LIVE, using  library (no key required for free tier).
- **Expo Push Notifications** â€” Planned (stubbed).
- **Signzy (KYC)** â€” Planned (stubbed).

**Testing status**
  - Testing agent used after significant changes: YES, used after backend refactoring.
  - Troubleshoot agent used after agent stuck in loop: NO.
  - Test files created: []
  - Known regressions: The  component breaks the Metro bundler.

**Credentials to test flow:**
- **Admin User:**  / 
- **MSG91 Auth Key:** 
- **Resend API Key:**  (This should be in the .env file)

**What agent forgot to execute**
- The agent was in the middle of implementing the Corporate vs. Individual account type feature and did not complete the frontend portion ( and ).
- The agent identified but did not fix the TypeScript linting errors in the frontend codebase.
- The frontend implementation for Admin Analytics and re-integration of the Crypto Price Chart on the dashboard are still pending.</analysis>
